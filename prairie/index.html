<script>
	// === Logique Prairie  ===

	(function () {
		// Paramètres géométriques des connecteurs
		const CURVE_RADIUS = 12;      // rayon des quarts de cercle
		const VERTICAL_SHIFT = 5;     // décalage vertical entre lignes (en haut)
		const HORIZ_SHORTEN = 5;      // "raccourci" horizontal avant descente
		const BUNDLE_SPACING = 5;     // espacement horizontal des rails au centre

		// Dates clés du trajet (en UTC pour éviter les surprises de fuseaux)
		function utcDate(year, month, day) {
			// month = 1–12
			return new Date(Date.UTC(year, month - 1, day));
		}

		const startDate = utcDate(2025, 9, 1);  // 1er septembre 2025
		const endDate = utcDate(2026, 6, 1);    // 1er juin 2026

		// Distance totale représentée par les pointillés
		const totalDistanceKm = 363.83e6;

		// Pour figer la progression à une date donnée :
		const USE_MANUAL_DATE = false;
		const MANUAL_DATE = utcDate(2025, 12, 6); // exemple

		const dateFormatter = new Intl.DateTimeFormat("fr-FR", {
			day: "numeric",
			month: "long",
			year: "numeric"
		});

		const numberFormatterMillions = new Intl.NumberFormat("fr-FR", {
			minimumFractionDigits: 1,
			maximumFractionDigits: 1
		});

		function progressFor(date) {
			const total = endDate.getTime() - startDate.getTime();
			if (total <= 0) return 0;

			let elapsed = date.getTime() - startDate.getTime();
			if (elapsed < 0) elapsed = 0;
			if (elapsed > total) elapsed = total;

			return elapsed / total; // 0 → départ (rouge, droite), 1 → arrivée (bleu, gauche)
		}

		function updateProgressOnce() {
			const now = USE_MANUAL_DATE ? MANUAL_DATE : new Date();
			const progress = progressFor(now);

			document.documentElement.style.setProperty(
				"--prairie-progress",
				progress.toString()
			);

			const dateLabel = document.getElementById("prairie-date-label");
			const distanceLabel = document.getElementById("prairie-distance-label");
			if (!dateLabel || !distanceLabel) return;

			dateLabel.textContent = "Aujourd’hui : " + dateFormatter.format(now);

			const traveledKm = totalDistanceKm * progress;
			const traveledMillions = traveledKm / 1e6;
			const totalMillions = totalDistanceKm / 1e6;



			distanceLabel.textContent =
				numberFormatterMillions.format(traveledMillions) +
				" / " +
				numberFormatterMillions.format(totalMillions) +
				" millions de km";
		}

		// Configuration des jalons/milestones
		const milestoneConfig = [
			{
				id: "ms-2025-09-26",
				date: utcDate(2025, 9, 26),
				label: "26 septembre 2025",
				title: "Gazette interplanétaire",
				main: `
        <h3 class="prairie-article-main-title">Chronique d’un départ déjà lointain</h3>
        <p>Ce matin-là, les cadrans indiquaient à peine l’équinoxe que déjà les regards se tournaient vers la trajectoire. Sur le papier, tout semblait figé : neuf mois de route, des millions de kilomètres, et pourtant une impression étrange de glissement continu, comme si le temps lui-même se laissait lentement étirer.</p>
        <p>Les premiers rapports mentionnent un calme presque suspect. Aucune turbulence notable, seulement la mécanique silencieuse d’un voyage bien préparé. Mais entre les lignes, on devine déjà les infimes décalages, ces gestes anodins qui, un jour, feront récit : une note griffonnée au verso, un calcul rectifié, un soupir retenu devant un écran trop lumineux.</p>
        <p>Pour l’instant, les chronomètres avancent en cadence, et l’on se surprend à écouter le souffle discret de la machine. Le départ est derrière, l’arrivée demeure compacte, lointaine. Entre les deux, une simple promesse : le ruban gris d’un trajet qui commence à peine à se dérouler.</p>
      `,
				secondary: `
        <h4 class="prairie-article-secondary-title">Brève de marge</h4>
        <p>Dans la marge d’un carnet, quelqu’un a tracé une petite orbite excentrée. Rien d’officiel, bien sûr, juste une hypothèse notée à la hâte : et si la route, au lieu d’être un trait, était déjà un souvenir en train de se réécrire&nbsp;?</p>
      `,
				editorial: `
        <p>On pourrait croire que le voyage ne commence qu’au moment où l’on quitte le bord. C’est un réflexe compréhensible : l’esprit aime les ruptures nettes, les départs théâtraux, les compte-à-rebours solennels.</p>
        <p>Mais la vérité est plus discrète. Le voyage a souvent débuté bien avant que la machine ne s’ébranle, dans ces instants où l’on hésite encore à appuyer sur «&nbsp;lancer&nbsp;». À partir de là, chaque jour compte, même si rien ne semble bouger.</p>
      `
			},
			{
				id: "ms-2025-12-01",
				date: utcDate(2025, 12, 1),
				label: "1 décembre 2025",
				title: "Chronique en saison froide",
				main: `
        <h3 class="prairie-article-main-title">Échos d’un trajet en veille</h3>
        <p>Avec l’entrée dans les jours les plus courts, la progression n’en paraît que plus abstraite. Les chiffres s’alignent pourtant avec une précision obstinée : des millions de kilomètres déjà franchis, un pourcentage qui grimpe, lentement, vers l’horizon du printemps.</p>
        <p>Dans les rapports, on évoque la monotonie apparente du trajet. Ce n’est ni un drame, ni une épopée, mais quelque chose de plus subtil : une patience organisée. On vérifie les instruments, on recale les horloges, on guette les infimes écarts comme on écouterait une note légèrement fausse dans une mélodie répétée.</p>
        <p>À cette étape, il devient clair que la route n’est pas qu’une distance à parcourir, mais un cadre imposé à l’attention. Ce que l’on choisit d’y placer — pensées, récits, projets, rêveries — finit par donner au voyage sa véritable texture.</p>
      `,
				secondary: `
        <h4 class="prairie-article-secondary-title">Coupure hivernale</h4>
        <p>Une petite coupure, en bas de colonne, signale un détail presque anodin&nbsp;: les observateurs ont noté une légère accélération du temps ressenti. Les journées paraissent plus brèves, les semaines glissent comme des feuilles fines, tournées un peu trop vite.</p>
      `,
				editorial: `
        <p>C’est une vieille habitude hivernale : croire que rien ne bouge parce que tout est enveloppé de silence. En réalité, les trajectoires s’ajustent, même dans l’immobilité apparente.</p>
        <p>Il faudrait peut-être accepter que la progression la plus décisive ne soit pas celle que l’on voit, mais celle que l’on consent à imaginer. Les chiffres nous rassurent, mais ce sont les histoires que nous tissons autour d’eux qui nous tiennent réellement chaud.</p>
      `
			},
			{
				id: "ms-2026-02-11",
				date: utcDate(2026, 2, 11),
				label: "11 février 2026",
				title: "Édition de mi-parcours",
				main: `
        <h3 class="prairie-article-main-title">Au cœur de la distance</h3>
        <p>À mi-chemin ou presque, la ligne de pointillés cesse d’être une abstraction&nbsp;: on en a déjà parcouru une bonne part, et l’on devine la portion restante comme une saignée claire dans l’avenir proche. Le curseur grisé pulse désormais avec la régularité rassurante d’un métronome.</p>
        <p>Les récits internes parlent d’ajustements minuscules, invisibles au lecteur pressé. Pourtant, ce sont ces corrections-là qui sculptent la trajectoire : un recalage de quelques heures, une réévaluation silencieuse d’objectifs intermédiaires, une façon plus fine de lire ce que disent vraiment les mesures.</p>
        <p>On sent poindre une légère impatience, mêlée à une forme de tendresse pour le trajet lui-même. On sait qu’il finira, et c’est peut-être cela qui le rend si étrange&nbsp;: chaque pointillé, déjà derrière, a eu son moment précis pour exister.</p>
      `,
				secondary: `
        <h4 class="prairie-article-secondary-title">Note de mi-course</h4>
        <p>Une brève note, presque perdue dans la maquette, suggère qu’il serait temps de préparer l’arrivée. Pas en la précipitant, mais en apprenant à regarder la distance restante comme un espace encore habitable, et non comme un simple retard à combler.</p>
      `,
				editorial: `
        <p>Nous aimons parler de «&nbsp;moitié du chemin&nbsp;» comme d’un tournant. C’est vrai, jusqu’à un certain point&nbsp;: nous avons assez de passé pour mesurer, assez d’avenir pour projeter.</p>
        <p>Mais cette position est aussi inconfortable&nbsp;: elle oblige à tenir ensemble ce qui est fait et ce qui reste. Peut-être est-ce justement là que la vigilance devient intéressante : non pas pour corriger un cap défaillant, mais pour apprendre à habiter, consciemment, le cœur même du trajet.</p>
      `
			}
		];

		// Tri chronologique (du plus ancien au plus récent) pour l’ordre des blocs
		const sortedMilestones = [...milestoneConfig].sort(
			(a, b) => a.date.getTime() - b.date.getTime()
		);

		const orderIndexById = {};
		sortedMilestones.forEach((m, i) => {
			orderIndexById[m.id] = i;
		});

		function createMilestones() {
			const track = document.getElementById("prairie-track");
			if (!track) return;

			milestoneConfig.forEach((ms) => {
				const button = document.createElement("button");
				button.type = "button";
				button.className = "prairie-milestone";
				button.setAttribute("aria-label", ms.label);
				button.title = ms.label;

				const frac = progressFor(ms.date);
				button.style.setProperty("--prairie-position", frac.toString());

				const orderIndex = orderIndexById[ms.id] ?? 0;
				button.dataset.milestoneId = ms.id;
				button.dataset.orderIndex = String(orderIndex);

				track.appendChild(button);
			});
		}

		function createBlocks() {
			const container = document.getElementById("prairie-milestone-blocks");
			if (!container) return;

			sortedMilestones.forEach((ms) => {
				const block = document.createElement("button");
				block.type = "button";
				block.className = "prairie-milestone-block";
				block.dataset.milestoneId = ms.id;

				block.innerHTML = `
          <span class="prairie-milestone-block-date">${ms.label}</span>
          <span class="prairie-milestone-block-title">${ms.title}</span>
        `;

				block.addEventListener("click", function () {
					selectMilestone(ms.id);
				});

				container.appendChild(block);
			});
		}

		function selectMilestone(id) {
			const data = milestoneConfig.find((m) => m.id === id);
			if (!data) return;

			const journal = document.getElementById("prairie-journal");
			const titleEl = document.getElementById("prairie-journal-title");
			const dateEl = document.getElementById("prairie-journal-date");
			const mainEl = document.getElementById("prairie-journal-main-article");
			const secondaryEl = document.getElementById("prairie-journal-secondary");
			const editorialEl = document.getElementById("prairie-journal-editorial-content");

			if (!journal || !titleEl || !dateEl || !mainEl || !secondaryEl || !editorialEl) {
				return;
			}

			titleEl.textContent = data.title;
			dateEl.textContent = data.label;
			mainEl.innerHTML = data.main;
			secondaryEl.innerHTML = data.secondary;
			editorialEl.innerHTML = data.editorial;

			journal.classList.remove("prairie-journal--hidden");

			const allMilestones = document.querySelectorAll(".prairie-milestone");
			allMilestones.forEach((el) => {
				el.classList.toggle(
					"prairie-milestone--active",
					el.dataset.milestoneId === id
				);
			});

			const allBlocks = document.querySelectorAll(".prairie-milestone-block");
			allBlocks.forEach((el) => {
				el.classList.toggle(
					"prairie-milestone-block--active",
					el.dataset.milestoneId === id
				);
			});
		}

		function closeJournal() {
			const journal = document.getElementById("prairie-journal");
			if (journal) {
				journal.classList.add("prairie-journal--hidden");
			}
			const allMilestones = document.querySelectorAll(".prairie-milestone");
			allMilestones.forEach((el) => {
				el.classList.remove("prairie-milestone--active");
			});
			const allBlocks = document.querySelectorAll(".prairie-milestone-block");
			allBlocks.forEach((el) => {
				el.classList.remove("prairie-milestone-block--active");
			});
		}

		// Connecteurs : 3 quarts de cercle (A) + segments droits
		function drawConnectors() {
			const svg = document.getElementById("prairie-connectors");
			const progressEl = document.querySelector(".prairie-progress");
			const legendEl = document.querySelector(".prairie-legend");
			if (!svg || !progressEl || !legendEl) return;

			const rect = progressEl.getBoundingClientRect();
			const legendRect = legendEl.getBoundingClientRect();

			svg.setAttribute("width", rect.width);
			svg.setAttribute("height", rect.height);

			while (svg.firstChild) {
				svg.removeChild(svg.firstChild);
			}

			const centerX = rect.width / 2;
			const count = sortedMilestones.length;
			if (count === 0) return;
			const centerIndex = (count - 1) / 2;

			const legendBottomLocal = legendRect.bottom - rect.top;

			sortedMilestones.forEach((ms, idx) => {


				const milestoneEl = document.querySelector(
					`.prairie-milestone[data-milestone-id="${ms.id}"]`
				);
				const blockEl = document.querySelector(
					`.prairie-milestone-block[data-milestone-id="${ms.id}"]`
				);

				if (!milestoneEl || !blockEl) return;

				const mRect = milestoneEl.getBoundingClientRect();
				const bRect = blockEl.getBoundingClientRect();

				const orderIndex = orderIndexById[ms.id] ?? idx;

				// Bas visuel de la tige
				const stemBottomY = mRect.bottom - rect.top;
				const P0x = mRect.left + mRect.width / 2 - rect.left;
				let P0y =
					stemBottomY + 4 + 25 + orderIndex * VERTICAL_SHIFT; // marge + tige + décalage haut

				// Colonne centrale pour ce connecteur
				const baseColumnX =
					centerX + (orderIndex - centerIndex) * BUNDLE_SPACING;

				// Direction vers le centre (1 = droite, -1 = gauche)
				let dirToCenter = baseColumnX >= P0x ? 1 : -1;

				// ==== 1er quart de cercle : bas de la tige → bas + côté vers le centre ====
				const P1x = P0x + dirToCenter * CURVE_RADIUS;
				const P1y = P0y + CURVE_RADIUS;

				// Barre horizontale vers la colonne centrale, légèrement raccourcie
				const pullback = HORIZ_SHORTEN * orderIndex;
				const columnX = baseColumnX - dirToCenter * pullback;

				const dirHoriz = columnX >= P1x ? 1 : -1;
				const P2x = columnX - dirHoriz * CURVE_RADIUS;
				const P2y = P1y;

				// ==== 2e quart de cercle : barre horizontale → rail vertical (sous la légende) ====
				const P3x = columnX;
				const P3y = P2y + CURVE_RADIUS;

				// Descente verticale au-delà de la légende, SANS rajouter le décalage vertical
				let P4x = columnX;
				let P4y = Math.max(
					P3y + CURVE_RADIUS,
					legendBottomLocal + 20
				);

				// ==== 3e quart de cercle : rail vertical → côté du bloc ====
				const blockCenterX = bRect.left + bRect.width / 2 - rect.left;
				const blockTopLocal = bRect.top - rect.top;

				const dirToBlock = blockCenterX >= P4x ? 1 : -1;
				const P5x = P4x + dirToBlock * CURVE_RADIUS;
				const P5y = P4y + CURVE_RADIUS;

				// Barre horizontale vers l’alignement du bloc
				const P6x = blockCenterX;
				const P6y = P5y;

				// Descente verticale finale sur le bord supérieur du bloc
				const P7x = blockCenterX;
				const P7y = blockTopLocal;

				// Construction du path : M → arc1 → L → arc2 → L → arc3 → L → L
				// Top arc was reversed → flip sweep1
				const baseSweep1 = dirToCenter > 0 ? 1 : 0;
				const sweep1 = 1 - baseSweep1;

				// 2e arc était bon → garder sweep2
				const baseSweep2 = dirHoriz > 0 ? 1 : 0;
				const sweep2 = baseSweep2;

				// 3e arc était inversé → flip sweep3


				const baseSweep3 = dirToBlock > 0 ? 1 : 0;
				const sweep3 = 1 - baseSweep3;

				const d =
					`M ${P0x} ${P0y} ` +
					// 1er quart de cercle (vers le centre, orienté correctement)
					`A ${CURVE_RADIUS} ${CURVE_RADIUS} 0 0 ${sweep1} ${P1x} ${P1y} ` +
					// barre horizontale vers la colonne centrale
					`L ${P2x} ${P2y} ` +
					// 2e quart de cercle vers le rail vertical (sous la légende)
					`A ${CURVE_RADIUS} ${CURVE_RADIUS} 0 0 ${sweep2} ${P3x} ${P3y} ` +
					// descente verticale sous la légende
					`L ${P4x} ${P4y} ` +
					// 3e quart de cercle vers le bloc (orienté correctement)
					`A ${CURVE_RADIUS} ${CURVE_RADIUS} 0 0 ${sweep3} ${P5x} ${P5y} ` +
					// barre horizontale vers le centre du bloc
					`L ${P6x} ${P6y} ` +
					// descente verticale finale
					`L ${P7x} ${P7y}`;

				const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
				path.setAttribute("d", d);
				svg.appendChild(path);
			});
		}

		document.addEventListener("DOMContentLoaded", function () {
			createMilestones();
			createBlocks();
			updateProgressOnce();
			drawConnectors();

			const closeBtn = document.getElementById("prairie-journal-close");
			if (closeBtn) {
				closeBtn.addEventListener("click", closeJournal);
			}

			window.addEventListener("resize", function () {
				drawConnectors();
			});
		});
	})();
</script>